<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- TensorFlow.js & tjvis -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>
  </head>
  
  <body>
    <script>
        // webserver: i opgave mappe kør kommando: npm install http-server -g
        // køre webserver med kommando: http-server -p 8080
        // åben http://127.0.0.1:8080/Linear.html

      async function run() {
        
        await tf.ready();

        const houseSalesDataset = tf.data.csv("/kc_house_data.csv");

        const pointsDataset = houseSalesDataset.map((record) => ({
          x: record.sqft_living,
          y: record.price,
        }));

        const points = await pointsDataset.toArray();
        if (points.length % 2 !== 0) {
            points.pop(); // Fjern sidste element hvis antallet er ulige
        }

        // Shuffle data for at sikre random ordering, så modellen ikke lærer i en bestemt rækkefølge
        tf.util.shuffle(points);
       
        plot(points, "Square Feet");

        const result = tf.tidy(() => {
        // Extract features and labels        
        const featureValues = points.map((p) => p.x);
        // featureValues konverteres til tensor med syntaxen: tf.tensor2d(data, shape)
        const featureTensor = tf.tensor2d(featureValues, [featureValues.length,1]);

        const labelValues = points.map((p) => p.y);
        const labelTensor = tf.tensor2d(labelValues, [labelValues.length, 1]);

        // Normaliser data vha. normalize function
        const normalisedFeature = normalize(featureTensor); // kun sqft_living værdier
        const normalisedLabel = normalize(labelTensor); // kun price værdier

         // Split datasæt i trænings- og testdata
        const [trainingFeatures, testingFeatures] = tf.split(normalisedFeature.tensor, 2);
        const [trainingLabels, testingLabels] = tf.split(normalisedLabel.tensor, 2);

        return { trainingFeatures, testingFeatures, trainingLabels, testingLabels };

        });

        console.log(tf.memory()) // tjekker hvor mange tensors der er i hukommelsen
      }
      run();

      // Funktion der visualiserer data i scatter plot
      function plot(points, featureName) {
        tfvis.render.scatterplot(
          { name: `${featureName} vs House Price` },
          { values: [points], series: ["original"] },
          {
            xLabel: featureName,
            yLabel: "Price",
          },
        );
      }

      // Funktion der normalizere data ved at trække middelværdien fra og dividere med standardafvigelsen
      // Formel:
      function normalize(tensor) {
        const max = tensor.max();
        const min = tensor.min();
        const normalisedTensor = tensor.sub(min).div(max.sub(min));
        return { tensor: normalisedTensor, min, max };
      }
      

      function denormalise(tensor, min, max) {
        return tensor.mul(max.sub(min)).add(min);
      }
    </script>
  </body>
</html>
